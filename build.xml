<!--
 | Detailed help documenation lives in docs/antHelp.txt, please refer to this file or
 | run 'ant help' for usage of this file.
 |
 | Comments in this file should be targeted to the maintenance of the build script.
 +-->
<project name="uPortal" default="help" basedir="." xmlns:up="urn:up-util-ant">
    <property file="build.properties" />


    <!--
     | Properties that describe the maven project
     +-->
    <property name="uportal-impl.dir" value="${basedir}/uportal-impl" />
    <property name="uportal-war.dir" value="${basedir}/uportal-war" />
    <property name="uportal-ear.dir" value="${basedir}/uportal-ear" />
    <property name="uportal-ear-deployer.dir" value="${basedir}/uportal-ear-deployer" />
    <property name="uportal-ant-tasks.dir" value="${basedir}/uportal-ant-tasks" />


    <!--
     | Import tasks and macros related to the maven structure of the project 
     +-->
    <import file="maven-support.build.xml" optional="false" />



    <!-- ============================== Public Targets ============================== -->

    <target name="help" description="Prints information about using this ant build file.">
        <loadfile property="helpMessage" srcFile="docs/antHelp.txt" />
        <echo message="${helpMessage}" />
    </target>

    <target name="initportal" description="Runs all the targets necessary to deploy the portal and prepare the portal database">
        <echo message="Initializing uPortal" />
        <antcall target="deploy" />
        <antcall target="db" />
        <antcall target="pubchan" />
        <antcall target="i18n-db" />
        <echo message="Finished initializing uPortal" />
    </target>

    <target name="db" description="Loads database tables and data">
        <uportal-impl-macro>
            <property name="usetable" value=" " />
            <property name="tablefile" value=" " />
            <property name="usedata" value=" " />
            <property name="datafile" value=" " />
            <property name="createscript" value=" " />
            <property name="droptables" value=" " />
            <property name="createtables" value=" " />
            <property name="populatetables" value=" " />
            <property name="localeaware" value=" " />
            <property name="adminlocale" value=" " />

            <echo message="Invoking DbLoader" />
            <java fork="true" failonerror="true" dir="${uportal-impl.dir}" classname="org.jasig.portal.tools.dbloader.DbLoader">
                <classpath refid="uportal-impl-full.classpath" />

                <arg value="${usetable}" />
                <arg value="${tablefile}" />
                <arg value="${usedata}" />
                <arg value="${datafile}" />
                <arg value="${createscript}" />
                <arg value="${droptables}" />
                <arg value="${createtables}" />
                <arg value="${populatetables}" />
                <arg value="${localeaware}" />
                <arg value="${adminlocale}" />
            </java>
        </uportal-impl-macro>
    </target>

    <target name="i18n-db" description="Loads internationalization tables and data">
        <echo message="Invoking DbLoader for localizationed database setting" />
        <antcall target="db">
            <param name="usetable" value="-t" />
            <param name="tablefile" value="/properties/db/tables-i18n.xml" />
            <param name="usedata" value="-d" />
            <param name="datafile" value="/properties/db/data-i18n.xml" />
        </antcall>
    </target>

    <target name="l10n-db" description="Loads localized data">
        <echo message="Invoking DbLoader for localizationed database setting" />
        <antcall target="db">
            <param name="locale" value="en_US" />
            <param name="usetable" value="-t" />
            <param name="tablefile" value="/properties/db/tables-l10n.xml" />
            <param name="usedata" value="-d" />
            <param name="datafile" value="/properties/db/data-l10n.xml" />
            <param name="localeaware" value="-l" />
            <param name="adminlocale" value="en_US" />
        </antcall>
    </target>

    <target name="pubchan" description="Publishes channels">
        <uportal-impl-macro>
            <!--
             | If no file or directory is specified, set a default directory
             +-->
            <if>
                <not>
                    <or>
                        <isset property="directory" />
                        <isset property="channel" />
                    </or>
                </not>
                <then>
                    <property name="directory" value="${uportal-impl.dir}/src/main/config/chanpub/" />
                </then>
            </if>

            <!--
             | Set argument prefix properties if the argument value exists
             +-->
            <if>
                <isset property="directory" />
                <then>
                    <property name="directoryArg" value="-d" />
                </then>
                <else>
                    <property name="directoryArg" value="" />
                    <property name="directory" value="" />
                </else>
            </if>
            <if>
                <isset property="channel" />
                <then>
                    <property name="channelArg" value="-f" />
                </then>
                <else>
                    <property name="channelArg" value="" />
                    <property name="channel" value="" />
                </else>
            </if>

            <echo message="Invoking Channel Publisher Tool" />
            <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.tools.chanpub.ChannelPublisher">
                <classpath refid="uportal-impl-full.classpath" />

                <arg value="${directoryArg}" />
                <arg value="${directory}" />

                <arg value="${channelArg}" />
                <arg value="${channel}" />
            </java>
        </uportal-impl-macro>
    </target>

    <target name="deploy" description="Deploy application to servlet container">
        <uportal-ant-tasks-macro>
            <typedef resource="org/jasig/portal/ant/antlib.xml" uri="urn:up-util-ant">
                <classpath refid="uportal-ant-tasks-full.classpath" />
            </typedef>

            <uportal-ear-macro>
                <up:tomcatEarDeploy ear="${uportal-ear.artifact}" catalinaHome="${server.home}" extractWars="true" removeExistingDirectories="true" />
            </uportal-ear-macro>
        </uportal-ant-tasks-macro>
    </target>



    <!-- ============================== Private Targets ============================== -->



    <!-- ============================== Ant Extensions ============================== -->

    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="${basedir}/bootstrap/ant-contrib-1.0b3.jar" />
        </classpath>
    </taskdef>


    <macrodef name="echo-path">
        <attribute name="pathref" />
        <sequential>
            <echo>echoing path=@{pathref}</echo>
            <for param="fromfile">
                <path refid="@{pathref}" />
                <sequential>
                    <echo>@{fromfile}</echo>
                </sequential>
            </for>
        </sequential>
    </macrodef>

    <macrodef name="echo-fileset">
        <attribute name="filesetref" />
        <sequential>
            <pathconvert pathsep=" " property="@{filesetref}.echopath">
                <path>
                    <fileset refid="@{filesetref}" />
                </path>
            </pathconvert>
            <echo>   ------- echoing fileset @{filesetref} -------</echo>
            <echo>${@{filesetref}.echopath}</echo>
        </sequential>
    </macrodef>
</project>