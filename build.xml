<project name="uPortal" default="help" basedir="." xmlns:artifact="urn:maven-artifact-ant">
    <!--
     | Properties that describe the project
     +-->
    <property name="uportal-impl.dir" value="${basedir}/uportal-impl" />



    <target name="help" description="Prints help message for project">
        <echo message="Run 'ant -p' to get a list of available targets for the project" />
    </target>

    <target name="db" description="Drops then re-initializes the uPortal database using the JDBC configuration from 'uportal-impl/src/main/resources/properties/rdbm.properties'">
        <uportalImplWrapper>
            <subTasks>
                <java fork="true" failonerror="true" dir="${uportal-impl.dir}" classname="org.jasig.portal.tools.dbloader.DbLoader">
                    <classpath refid="uportal-impl-full.classpath" />
                </java>
            </subTasks>
        </uportalImplWrapper>
    </target>

    <!--
     | Provides a wrapper for tasks that need a classpath that includes the uPortal source
     | and all of its dependencies. The task also ensures the uportal-impl jar exists and
     | is up to date.
     |
     | The following are available to subTasks:
     | pom object   - uportal-impl                  - The Maven POM object for the uportal-impl pom
     | property     - uportal-impl.jar              - The full path to the uportal-impl JAR
     | path         - uportal-impl.classpath        - The uportal-impl classpath not including the uportal-impl JAR
     | path         - uportal-impl-full.classpath   - The uportal-impl classpath including the uportal-impl JAR
     +-->
    <macrodef name="uportalImplWrapper">
        <element name="subTasks" optional="no" />

        <sequential>
            <!--
             | Load the uportal-impl pom and classpath
             +-->
            <artifact:pom file="${uportal-impl.dir}/pom.xml" id="uportal-impl" />
            <artifact:dependencies pathid="uportal-impl.classpath" verbose="false">
                <pom refid="uportal-impl" />
            </artifact:dependencies>

            <!--
             | Define the location of the uportal-impl JAR
             +-->
            <property name="uportal-impl.jar" value="${uportal-impl.dir}/target/${uportal-impl.build.finalName}.jar" />

            <!--
             | Include the uportal-impl JAR in the final classpath
             +-->
            <path id="uportal-impl-full.classpath">
                <path refid="uportal-impl.classpath" />
                <pathelement location="${uportal-impl.jar}" />
            </path>

            <!--
             | Call 'mvn package' if the source code or resources are not up-to-date
             +-->
            <if>
                <not>
                    <uptodate targetfile="${uportal-impl.jar}">
                        <srcresources>
                            <fileset dir="${uportal-impl.dir}/src/main/java">
                                <include name="**/*.java" />
                            </fileset>
                            <fileset dir="${uportal-impl.dir}/src/main/resources">
                                <exclude name="**/.svn" />
                            </fileset>
                        </srcresources>
                    </uptodate>
                </not>
                <then>
                    <echo message="${uportal-impl.jar} is not available or out-of-date, calling 'mvn package'" />
                    <antcall target="mvn">
                        <param name="dir" value="${uportal-impl.dir}" />
                        <param name="goal" value="package" />
                    </antcall>
                </then>
            </if>

            <!--
             | Execute the sub-tasks
             +-->
            <subTasks />
        </sequential>
    </macrodef>


    <target name="mvn">
        <property name="goal" value="" />
        <property name="goal1" value="" />
        <property name="goal2" value="" />
        <property name="goal3" value="" />
        <property name="goal4" value="" />
        <property name="goal5" value="" />
        <property name="goal6" value="" />
        <property name="goal7" value="" />
        <property name="goal8" value="" />
        <property name="goal9" value="" />

        <if>
            <os family="windows" />
            <then>
                <property name="mvnExecutable" value="mvn.bat" />
            </then>
            <else>
                <property name="mvnExecutable" value="mvn" />
            </else>
        </if>

        <exec executable="mvn" dir="${dir}" vmlauncher="true" resolveexecutable="true" searchpath="true" failonerror="true">
            <arg value="${goal}" />
            <arg value="${goal1}" />
            <arg value="${goal2}" />
            <arg value="${goal3}" />
            <arg value="${goal4}" />
            <arg value="${goal5}" />
            <arg value="${goal6}" />
            <arg value="${goal7}" />
            <arg value="${goal8}" />
            <arg value="${goal9}" />
        </exec>
    </target>


    <!--
     | Load ant extensions
     +-->
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant">
        <classpath>
            <pathelement location="${basedir}/bootstrap/maven-ant-tasks-2.0.7.jar" />
        </classpath>
    </typedef>

    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="${basedir}/bootstrap/ant-contrib-1.0b3.jar" />
        </classpath>
    </taskdef>
</project>