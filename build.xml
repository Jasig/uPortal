<project name="uPortal" default="help" basedir="." xmlns:artifact="urn:maven-artifact-ant">
    <!--
     | Properties that describe the project
     +-->
    <property name="uportal-impl.dir" value="${basedir}/uportal-impl" />



    <target name="help" description="Prints help message for project">
        <echo message="Run 'ant -p' to get a list of available targets for the project" />
    </target>

    <target name="initportal" description="Runs all the targets necessary to deploy the portal and prepare the portal database">
        <echo message="Initializing uPortal" />
        <!-- TODO <antcall target="deploy" /> -->
        <antcall target="db" />
        <antcall target="pubchan" />
        <antcall target="i18n-db" />
        <echo message="Finished initializing uPortal" />
    </target>

    <target name="db" description="Loads database tables and data">
        <uportalImplWrapper>
            <subTasks>
                <property name="usetable" value=" " />
                <property name="tablefile" value=" " />
                <property name="usedata" value=" " />
                <property name="datafile" value=" " />
                <property name="createscript" value=" " />
                <property name="droptables" value=" " />
                <property name="createtables" value=" " />
                <property name="populatetables" value=" " />
                <property name="localeaware" value=" " />
                <property name="adminlocale" value=" " />

                <echo message="Invoking DbLoader" />
                <java fork="true" failonerror="true" dir="${uportal-impl.dir}" classname="org.jasig.portal.tools.dbloader.DbLoader">
                    <classpath refid="uportal-impl-full.classpath" />

                    <arg value="${usetable}" />
                    <arg value="${tablefile}" />
                    <arg value="${usedata}" />
                    <arg value="${datafile}" />
                    <arg value="${createscript}" />
                    <arg value="${droptables}" />
                    <arg value="${createtables}" />
                    <arg value="${populatetables}" />
                    <arg value="${localeaware}" />
                    <arg value="${adminlocale}" />
                </java>
            </subTasks>
        </uportalImplWrapper>
    </target>

    <target name="i18n-db" description="Loads internationalization tables and data">
        <echo message="Invoking DbLoader for localizationed database setting" />
        <antcall target="db">
            <param name="usetable" value="-t" />
            <param name="tablefile" value="/properties/db/tables-i18n.xml" />
            <param name="usedata" value="-d" />
            <param name="datafile" value="/properties/db/data-i18n.xml" />
        </antcall>
    </target>

    <target name="l10n-db" description="Loads localized data">
        <echo message="Invoking DbLoader for localizationed database setting" />
        <antcall target="db">
            <param name="locale" value="en_US" />
            <param name="usetable" value="-t" />
            <param name="tablefile" value="/properties/db/tables-l10n.xml" />
            <param name="usedata" value="-d" />
            <param name="datafile" value="/properties/db/data-l10n.xml" />
            <param name="localeaware" value="-l" />
            <param name="adminlocale" value="en_US" />
        </antcall>
    </target>

    <target name="pubchan" description="Publishes channels">
        <uportalImplWrapper>
            <subTasks>
                <!--
                 | If no channel or directory specified, set default directory
                 +-->
                <if>
                    <not>
                        <or>
                            <isset property="directory" />
                            <isset property="channel" />
                        </or>
                    </not>
                    <then>
                        <property name="directory" value="${uportal-impl.dir}/src/main/config/chanpub/" />
                    </then>
                </if>

                <!--
                 | Set argument prefix properties if the argument value exists
                 +-->
                <if>
                    <isset property="directory" />
                    <then>
                        <property name="directoryArg" value="-d" />
                    </then>
                    <else>
                        <property name="directoryArg" value="" />
                        <property name="directory" value="" />
                    </else>
                </if>
                <if>
                    <isset property="channel" />
                    <then>
                        <property name="channelArg" value="-f" />
                    </then>
                    <else>
                        <property name="channelArg" value="" />
                        <property name="channel" value="" />
                    </else>
                </if>

                <echo message="Invoking Channel Publisher Tool" />
                <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.tools.chanpub.ChannelPublisher">
                    <classpath refid="uportal-impl-full.classpath" />

                    <arg value="${directoryArg}" />
                    <arg value="${directory}" />

                    <arg value="${channelArg}" />
                    <arg value="${channel}" />
                </java>
            </subTasks>
        </uportalImplWrapper>
    </target>



    <!--
     | Provides a wrapper for tasks that need a classpath that includes the uPortal source
     | and all of its dependencies. The task also ensures the uportal-impl jar exists and
     | is up to date.
     |
     | The following are available to subTasks:
     | pom object   - uportal-impl                  - The Maven POM object for the uportal-impl pom
     | property     - uportal-impl.jar              - The full path to the uportal-impl JAR
     | path         - uportal-impl.classpath        - The uportal-impl classpath not including the uportal-impl JAR
     | path         - uportal-impl-full.classpath   - The uportal-impl classpath including the uportal-impl JAR
     +-->
    <macrodef name="uportalImplWrapper">
        <element name="subTasks" optional="no" />

        <sequential>
            <!--
             | Load the uportal-impl pom and classpath
             +-->
            <artifact:pom file="${uportal-impl.dir}/pom.xml" id="uportal-impl" />
            <artifact:dependencies pathid="uportal-impl.classpath" verbose="false">
                <pom refid="uportal-impl" />
            </artifact:dependencies>

            <!--
             | Define the location of the uportal-impl JAR
             +-->
            <property name="uportal-impl.jar" value="${uportal-impl.dir}/target/${uportal-impl.build.finalName}.jar" />

            <!--
             | Include the uportal-impl JAR in the final classpath
             +-->
            <path id="uportal-impl-full.classpath">
                <path refid="uportal-impl.classpath" />
                <pathelement location="${uportal-impl.jar}" />
            </path>

            <!--
             | Call 'mvn package' if the source code or resources are not up-to-date
             +-->
            <if>
                <not>
                    <uptodate targetfile="${uportal-impl.jar}">
                        <srcresources>
                            <fileset dir="${uportal-impl.dir}/src/main/java">
                                <include name="**/*.java" />
                            </fileset>
                            <fileset dir="${uportal-impl.dir}/src/main/resources">
                                <exclude name="**/.svn" />
                            </fileset>
                        </srcresources>
                    </uptodate>
                </not>
                <then>
                    <echo message="${uportal-impl.jar} is not available or out-of-date, calling 'mvn package'" />
                    <antcall target="mvn">
                        <param name="dir" value="${uportal-impl.dir}" />
                        <param name="goal" value="package" />
                    </antcall>
                </then>
            </if>

            <!--
             | Execute the sub-tasks
             +-->
            <subTasks />
        </sequential>
    </macrodef>


    <!--
     | Utility target for executing a maven with some number (up to 10) of goals. The
     | target should automaticly work on all OSs as long as 'mvn' is on the path.
     +-->
    <target name="mvn">
        <property name="goal" value="" />
        <property name="goal1" value="" />
        <property name="goal2" value="" />
        <property name="goal3" value="" />
        <property name="goal4" value="" />
        <property name="goal5" value="" />
        <property name="goal6" value="" />
        <property name="goal7" value="" />
        <property name="goal8" value="" />
        <property name="goal9" value="" />

        <if>
            <os family="windows" />
            <then>
                <property name="mvnExecutable" value="mvn.bat" />
            </then>
            <else>
                <property name="mvnExecutable" value="mvn" />
            </else>
        </if>

        <exec executable="mvn" dir="${dir}" vmlauncher="true" resolveexecutable="true" searchpath="true" failonerror="true">
            <arg value="${goal}" />
            <arg value="${goal1}" />
            <arg value="${goal2}" />
            <arg value="${goal3}" />
            <arg value="${goal4}" />
            <arg value="${goal5}" />
            <arg value="${goal6}" />
            <arg value="${goal7}" />
            <arg value="${goal8}" />
            <arg value="${goal9}" />
        </exec>
    </target>


    <!--
     | Load ant extensions
     +-->
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant">
        <classpath>
            <pathelement location="${basedir}/bootstrap/maven-ant-tasks-2.0.7.jar" />
        </classpath>
    </typedef>

    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="${basedir}/bootstrap/ant-contrib-1.0b3.jar" />
        </classpath>
    </taskdef>
</project>