<project name="uPortal-ear" basedir=".">
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="../bootstrap/ant-contrib-1.0b3.jar" />
        </classpath>
    </taskdef>

    <target name="assemblePortlets">
        <property name="tempWarDir" value="target/plutoAssembly"/>
        
        <foreach target="assembleWar" param="warFile">
            <path>
                <fileset dir="target">
                    <include name="**/*.war" />
                </fileset>
            </path>

            <param name="maven.plugin.classpath" value="${maven.plugin.classpath}" />
            <param name="tempWarDir" value="${tempWarDir}"/>
        </foreach>
        
        <delete dir="${tempWarDir}"/>
    </target>

    <target name="assembleWar">
        <basename property="webAppName" file="${warFile}" suffix=".war"/>
        <property name="tempWebAppDir" value="${tempWarDir}/${webAppName}"/>
        
        <!-- extracts & assembles the webapp -->
        <echo message="Assembling: ${warFile} to: ${tempWarDir}" />
        <java fork="true" failonerror="true" dir="${basedir}" classname="org.danann.cernunnos.runtime.Main">
            <classpath>
                <pathelement path="target/classes" />
                <pathelement path="${maven.plugin.classpath}"/>
            </classpath>
            
            <arg value="classpath://org/jasig/portal/container/deploy/deploy-archives.crn" />
            <arg value="${warFile}" />

            <arg value="${tempWarDir}" />
        </java>
        
        <!-- re-package the webapp to a temp name, then replace the original -->
        <war destfile="${warFile}.new" 
            webxml="${tempWebAppDir}/WEB-INF/web.xml" 
            manifest="${tempWebAppDir}/META-INF/MANIFEST.MF">
            <fileset dir="${tempWebAppDir}">
                <exclude name="WEB-INF/web.xml"/>
            </fileset>
        </war>
        <move file="${warFile}.new" tofile="${warFile}" overwrite="true"/>
        
        <!-- delete the temp directory -->
        <delete dir="${tempWebAppDir}"/>        
    </target>
</project>
